<script>
const CHAT_KEY = "globalChat";
const TYPING_KEY = "typingUsers";
const TYPING_TIMEOUT = 2000;

// Ensure login
const currentUser = getCurrentUser();

// Load messages
function loadChat() {
  let chat = JSON.parse(localStorage.getItem(CHAT_KEY)) || [];
  let box = document.getElementById("messages");
  box.innerHTML = "";

  chat.forEach(msg => {
    let div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<span class="user">${msg.user}:</span> ${msg.text}`;
    box.appendChild(div);
  });

  box.scrollTop = box.scrollHeight;
}

// Send message
function sendMessage() {
  let input = document.getElementById("chatInput");
  let text = input.value.trim();
  if (!text) return;

  let chat = JSON.parse(localStorage.getItem(CHAT_KEY)) || [];
  chat.push({
    user: currentUser,
    text,
    time: Date.now()
  });

  if (chat.length > 100) chat.shift();

  localStorage.setItem(CHAT_KEY, JSON.stringify(chat));
  input.value = "";
  stopTyping();
  loadChat();
}

// Typing indicator
function handleTyping() {
  let typing = JSON.parse(localStorage.getItem(TYPING_KEY)) || {};
  typing[currentUser] = Date.now();
  localStorage.setItem(TYPING_KEY, JSON.stringify(typing));
}

// Stop typing
function stopTyping() {
  let typing = JSON.parse(localStorage.getItem(TYPING_KEY)) || {};
  delete typing[currentUser];
  localStorage.setIt
