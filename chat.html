<!DOCTYPE html>
<html>
<head>
  <title>Testit - Chat</title>
  <script src="helper.js"></script>
  <style>
    body { margin:0; font-family:Arial; background:#0b1020; color:white; }
    .box { max-width:600px; margin:40px auto; background:#1f2937; padding:20px; border-radius:12px; height:70vh; display:flex; flex-direction:column; }
    .messages { flex:1; background:#111827; padding:10px; border-radius:8px; overflow-y:auto; }
    .msg { margin-bottom:6px; }
    .user { color:#60a5fa; font-weight:bold; }
    .row { display:flex; gap:10px; margin-top:10px; }
    input { flex:1; padding:10px; border-radius:8px; border:none; }
    button { padding:10px; border-radius:8px; border:none; background:#2563eb; color:white; }
    .typing { font-size:12px; color:#9ca3af; margin-top:5px; height:14px; }
  </style>
</head>
<body>

<script>
  loadTopbar();
  const currentUser = getCurrentUser();
</script>

<div class="box">
  <h2>ðŸ’¬ Global Chat</h2>
  <div id="messages" class="messages"></div>

  <div class="row">
    <input id="chatInput" placeholder="Type a message">
    <button onclick="send()">Send</button>
  </div>
  <div id="typing" class="typing"></div>
</div>

<script>
const CHAT = "globalChat";
const TYPING = "typingUsers";

function load() {
  let chat = JSON.parse(localStorage.getItem(CHAT)) || [];
  let box = document.getElementById("messages");
  box.innerHTML = "";
  chat.forEach(m => {
    box.innerHTML += `<div class="msg"><span class="user">${m.user}:</span> ${m.text}</div>`;
  });
  box.scrollTop = box.scrollHeight;
}

function send() {
  let input = document.getElementById("chatInput");
  if (!input.value.trim()) return;

  let chat = JSON.parse(localStorage.getItem(CHAT)) || [];
  chat.push({ user: currentUser, text: input.value, time: Date.now() });
  if (chat.length > 100) chat.shift();

  localStorage.setItem(CHAT, JSON.stringify(chat));
  input.value = "";
  stopTyping();
  load();
}

function typing() {
  let t = JSON.parse(localStorage.getItem(TYPING)) || {};
  t[currentUser] = Date.now();
  localStorage.setItem(TYPING, JSON.stringify(t));
}

function stopTyping() {
  let t = JSON.parse(localStorage.getItem(TYPING)) || {};
  delete t[currentUser];
  localStorage.setItem(TYPING, JSON.stringify(t));
}

function showTyping() {
  let t = JSON.parse(localStorage.getItem(TYPING)) || {};
  let now = Date.now();
  let active = Object.keys(t).filter(u => u !== currentUser && now - t[u] < 2000);
  document.getElementById("typing").textContent =
    active.length === 1 ? `${active[0]} is typingâ€¦` :
    active.length > 1 ? `Multiple people are typingâ€¦` : "";
}

document.getElementById("chatInput").addEventListener("keydown", e => {
  if (e.key === "Enter") send();
  else typing();
});
document.getElementById("chatInput").addEventListener("blur", stopTyping);

setInterval(() => { load(); showTyping(); }, 500);
load();
</script>

</body>
</html>
